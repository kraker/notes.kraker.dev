---
title: HA T2S Notes
date: 2021-04-13 16:47
---

# HA T2S Notes
[Source](https://wiki.inmotionhosting.com/index.php?title=HA_T2S_Notes)

## The Platform

We use _Virtuozzo 6.0 (AKA Parallels Cloud Server)_

## The Servers

HA servers are divided into 2 groups:
* Compute nodes
	+ Run VZ containers 
	+ Store data locally on SSDs
* Storage nodes
	+ Provide cost efficient way to provide large amounts of disk space.
	+ Provide _fault tolerance_. 
	+ Data is replicated 3 times accross the cluster

All nodes are connected via 20GigE LACP backlan

## The Cloud

HA provided by servers linked together with various services at various mount
points. 
* Compute nodes have mount point available at `/pstorage/{cluster_name}`
	+ This is replicated accross all servers in the cluster
	+ This mount point is constructed with _chunk_ drives accross the cluster mounted
		at `/cs/{block_device}`
	+ With data replicated 3 times, we can lose any 2 servers without data loss.

## The Services

HA is provided by the following services running on the nodes:
* shamand (compute nodes)
	+ Maintains a list of which compute nodes are hosting which containers. 
	+ If shaman detects that another server has gone down the _cluster master_
		will distribute the offline containers to the rest of the compute servers in
		the cluster.
	+ If the daemon is stopped the other nodes will assume the node is offline.
* pstorage-csd (both compute nodes and storage nodes)
	+ Exposes one chunk drive (holding customer data) to the cluster. 
	+ If this daemon is stopped other nodes will assume the chunk it's responsible
		for is offline and begin relocating the data elsewhere.
	+ If all csd daemons are stopped the server can still host containers but all
		I/O will traverse the backlan at a performance penalty.
* pstorage-mdsd (Metadata Servers, Usually Compute)
	+ Maintains the metadata for the cluster (inodes/settings/etc). 
	+ If this daemon is stopped the other nodes will assume the metadata server is
		offline.
	+ We can only lose up to, but not exactly, 50% of the metadata servers in the
		cluster.
	+ The cluster will stop working unless metadata servers in a cluster is above
		50%.

## The Commands

* `shaman`
	```
	shaman stat
	```
* `pstorage -c imh-havp2 stat` (top interface also available)
* `pstorage -c imh-havep2 mnt-top` (like `pstorage top`, but focused on chunks
	and container I/O)
* `pstorage -c imh-havp2 mds-log-tail` (another way to view mds logs)

## Monitoring

Cluster health is monitored in **Icinga**

* `ha_license` - Monitors our license status as reported by pstorage
	```
	License Expiration: OK (33 days left) - License Usage: OK (289 GiB / 2500 GiB)
	```
* `ha_meta` - Monitors the metadat server count as reported by `pstorage`:
	```
	CRITICAL - Total: 5 Active: 4
	```
* `ha_chunk` - Monitors the chunk servers for bad chunks (offline disks):
	```
	CRITICAL - Bad chunks: 1104 1105 1106 1107 1108 1109 1110 1111 1112 1113 1114 1115 1116 1117
	```

## Charts and Graphs

To access _cloud_ features the following must be true:
* Must be an _HA_ class VPS
* Must be migrated to cloud using normal _eDesk_ funtionality.
	- [ ] ^ I'm not sure what this means?

Then you will be able to see the charts/graphs in "Manage My Cloud..." in AMP.

Alternatively you can access the **Graphite** browser
[directly](https://ash-eng-pro-graphite2.imhadmin.net/)

## Snapshots

* Snapshots are similar to a backup, but not a backup technically.
	+ Snapshots are intrinsically linked to the original data source.
* You can create as many snapshots as you like, but they expire after 10 days.
	+ _Long Term Storage Slots_ need to be purchased at $12 per slot to keep
		snapshots longer than 10 days
* Restoring a snapshot reverts the entire container to that time. 
* Snapshots cause SSH sessions to close
* Snapshots are one of the benefits of using _ploop_ as the container file
	system. [ploop](https://openvz.org/Ploop/Why)
* Understanding [snapshots](http://openvz.livejournal.com/44508.html)

## Official Documentation

http://download.parallels.com/doc/pcs/html/Parallels_Cloud_Server_Users_Guide/
http://www.odin.com/fileadmin/parallels/documents/hosting-cloud-enablement/pcs/Production_Documents/parallels_command_line_reference_guide_06142013.pdf

## Internal Documentation

http://wiki.inmotionhosting.com/index.php?title=HA_Node_Setup



